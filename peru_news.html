<!DOCTYPE html>
<html>
<head>
<title>Noticias del Peru al minuto</title>

<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<meta name="keywords" content="news, world news, usa news, sports news, politics" />
<link rel="stylesheet" href="tabs.css" type="text/css" media="screen" />
<style>
	body{background : #1E90FF;}
	b{font-size:1em !important;}
</style>
<link rel="stylesheet" href="jtempl.css" type="text/css" media="screen" />

<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />
<link rel="icon" type="image/png" href="images/favicon.png">
<link href='http://fonts.googleapis.com/css?family=Vollkorn:400,700' rel='stylesheet' type='text/css'>

<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery.tmpl.min.js"></script>

<script id="newsTemplate" type="text/x-jquery-tmpl"> 
  <tr>
  <td>
  <div class="links">${title}&nbsp;&nbsp;&nbsp;<a href="#" onclick="hrefClick(event)" 
title="${title}">mas...</a></div>
  {{if img != ''}}<img class="lavida" src="${img}" />{{/if}}
  <div class="htext" style="font-size: 1.2em;font-weight:bold;"><pre>${getHtml(html)}</pre></div>
  </td>
     <td class="user-photo"><img class="user-tumb" src="images/${logo}"/></td>
     <td style="color:black;font-size:1.1em;text-align:center;">${getDate(pubdate)}</td>
  </tr>
</script>

<script type="text/javascript">
    var savetds = [];
    
    $(document).ajaxStart(function(){$('.loadingDiv').show();});
    $(document).ajaxStop(function(){$('.loadingDiv').hide();});
    $(document).ready(function() {
	$(".tablinks").eq(0).click(); //default ACTUALIDAD
    });

    $.fn.OverFlowed = function() {
    	var _elm = $(this)[0];
    	var _hasScrollBar = false; 
    	if ((_elm.clientHeight < _elm.scrollHeight) || (_elm.clientWidth < _elm.scrollWidth)) {
        	_hasScrollBar = true;
    	}
    	return _hasScrollBar;
    };

    $.fn.scrollView = function () {
        return this.each(function () {
        $('html, body').animate({
        scrollTop: $(this).offset().top
        }, 500);
    	});
    };

    function getHtml(html) {
    	var tt = html.replace(/\s{2,}/g, "&#10;");
    	tt = tt.replace(/M&#225;s informaci&#243;n\n*/g, "").replace(/Si te interes.*newsletter\./g, ""); 
    	tt = tt.replace(/puedes ver:.*$/g, "").replace(/\(Fuente:.*$/g, "");
	return tt.replace(/\.([A-Z])/g, ". $1");
    }

    function openNews(evt, newsType, newsName) {
        $(".tablinks").removeClass("active");
        $(evt.target).addClass("active");
        $.getJSON("getNews.php?type=" + newsType, function (news) {
        	$("#newsList").empty();
            	$("#newsTemplate").tmpl(news).appendTo("#newsList");
		$(".htext").each(function(){
			var dina = $(this).html().replace(/&lt;\/b&gt;/g,'</b>').replace(/&lt;b&gt;/g,'<b>');
			$(this).html('');
			var pre = $("<pre> " + dina + " </pre>");
			$(this).append(pre);
			if(!$(this).OverFlowed()){
			   $(this).parent().find("a").remove();
			}
		        document.getElementById("title").innerHTML = newsName;
            	});
        });
    }

    function getDate(jsonDate) { //2016-12-13 19:21:45 mysql DateTime
        var tokens = jsonDate.split(" ");
        jsonDate = tokens[0] + "T" + tokens[1] + "Z"; //2016-12-13T19:21:45Z UTC time
	    var jdt = new Date(jsonDate);
  	    var rvalue = Math.ceil((Date.now() - jdt.getTime())/60000);
  	    if (rvalue < 60 && rvalue > 0)
  	        return "hace " + rvalue + (rvalue === 1 ? " minuto" : " minutos");
  	    else {
  	        return jdt.toLocaleString();
  	    }
    }

    function hrefClick(event){
	event.preventDefault();
	var elem = $(event.target).parent().next();
	if(elem.is( "img" )) elem = elem.next();
	if($(event.target).text() == "mas..."){
		if(savetds.length >0){
			var tdd = $("table tbody").find("td[colspan='3']");
		        tdd.parent().append(savetds[0]);
		        tdd.parent().append(savetds[1]);
		        savetds = [];
			tdd.removeAttr("colspan");
			$(":last-child", tdd).addClass("htext");		
			tdd.find("a").text("mas...");
		}
		savetds.push($(event.target).parent().parent().next().clone()); //remove the img and date
		$(event.target).parent().parent().next().remove();
		savetds.push($(event.target).parent().parent().next().clone());
		$(event.target).parent().parent().next().remove();
		$(event.target).parent().parent().attr("colspan", "3"); //have td ocuppy all 3 columns
		elem.removeClass("htext");
        	$(event.target).text("menos...");
        }else{
		$(event.target).parent().parent().parent().append(savetds[0]);
		$(event.target).parent().parent().parent().append(savetds[1]);
		savetds = [];
		$(event.target).parent().parent().removeAttr("colspan");
		elem.addClass("htext");
        	$(event.target).text("mas...");
        }
		setTimeout(function(){ $(event.target).scrollView();}, 10);
    }

</script>


</head>
<body>

<h2 style="text-align:center;margin-bottom:0;">Noticias del Peru<br />Actualizadas cada 10 minutos</h2>
<div class="box-table" >
<ul class="tab">
  <li><a href="javascript:void(0)" class="tablinks" onclick="openNews(event, 8, 'Actualidad')">Actualidad</a></li>
  <li><a href="javascript:void(0)" class="tablinks" onclick="openNews(event, 9, 'Deporte')">Deporte</a></li>
  <li><a href="javascript:void(0)" class="tablinks" onclick="openNews(event, 10, 'Politica')">Politica</a></li>
  <li><a href="javascript:void(0)" class="tablinks" onclick="openNews(event, 11, 'Entretenimiento')">Entretenimiento</a></li>
</ul>
</div>

<div class="box-table">
<table>
<thead><tr>
 <th id="title"></th>
 <th>Fuente</th>
 <th>Fecha</th>
</tr></thead>


<tbody id="newsList"></tbody>
</table>
</div>
<div class="loadingDiv"><img src="images/loading_green.gif" width="100px;"></div>
</body>
</html> 
